<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Clipper & Scissors Sales EDA</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #050816;
      --bg-elevated: #0b1020;
      --bg-soft: #111729;
      --accent: #4f46e5;
      --accent-soft: rgba(79, 70, 229, 0.15);
      --accent-strong: #6366f1;
      --text: #f9fafb;
      --muted: #9ca3af;
      --border: #1f2937;
      --danger: #ef4444;
      --success: #22c55e;
      --radius-lg: 18px;
      --radius-sm: 10px;
      --shadow-soft: 0 25px 60px rgba(0, 0, 0, 0.65);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #111827 0, #020617 55%, #000 100%);
      color: var(--text);
      min-height: 100vh;
      padding: 20px;
    }

    .app {
      max-width: 1200px;
      margin: 0 auto;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
      margin-bottom: 18px;
      gap: 16px;
    }

    .title-block h1 {
      font-size: 1.9rem;
      letter-spacing: 0.03em;
    }

    .title-block p {
      color: var(--muted);
      margin-top: 4px;
      font-size: 0.9rem;
    }

    .pill {
      padding: 6px 12px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      color: var(--muted);
      font-size: 0.78rem;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: rgba(15, 23, 42, 0.8);
      backdrop-filter: blur(12px);
      white-space: nowrap;
    }

    .pill span.key {
      font-family: "JetBrains Mono", Menlo, Consolas, monospace;
      background: rgba(55, 65, 81, 0.75);
      padding: 2px 6px;
      border-radius: 7px;
      color: #e5e7eb;
      font-size: 0.75rem;
    }

    .shell {
      display: grid;
      grid-template-columns: minmax(0, 260px) minmax(0, 1fr);
      gap: 16px;
      align-items: flex-start;
    }

    /* Sidebar filters */
    .sidebar {
      background: radial-gradient(circle at top left, #111827 0, #020617 55%);
      border-radius: var(--radius-lg);
      padding: 16px 14px;
      border: 1px solid rgba(55, 65, 81, 0.85);
      box-shadow: var(--shadow-soft);
      position: sticky;
      top: 20px;
    }

    .sidebar h2 {
      font-size: 0.95rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--muted);
      margin-bottom: 10px;
    }

    .sidebar-section {
      margin-bottom: 14px;
    }

    .sidebar-section label {
      font-size: 0.8rem;
      color: var(--muted);
      display: block;
      margin-bottom: 4px;
    }

    .sidebar select,
    .sidebar input {
      width: 100%;
      padding: 8px 9px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(15, 23, 42, 0.9);
      color: var(--text);
      font-size: 0.85rem;
      outline: none;
      transition: border 0.15s ease, box-shadow 0.15s ease,
        background 0.15s ease;
    }

    .sidebar select:focus,
    .sidebar input:focus {
      border-color: var(--accent-strong);
      box-shadow: 0 0 0 1px rgba(99, 102, 241, 0.7);
      background: #020617;
    }

    .sidebar .group-row {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px;
    }

    .sidebar button {
      width: 100%;
      margin-top: 6px;
      padding: 8px 10px;
      border-radius: 999px;
      border: none;
      font-size: 0.84rem;
      cursor: pointer;
      background: linear-gradient(135deg, #4f46e5, #818cf8);
      color: white;
      font-weight: 500;
      transition: transform 0.07s ease, box-shadow 0.07s ease,
        filter 0.12s ease;
      box-shadow: 0 10px 30px rgba(79, 70, 229, 0.5);
    }

    .sidebar button:hover {
      filter: brightness(1.04);
      transform: translateY(-1px);
      box-shadow: 0 14px 36px rgba(79, 70, 229, 0.7);
    }

    .sidebar button.secondary {
      margin-top: 4px;
      background: transparent;
      border: 1px solid rgba(148, 163, 184, 0.7);
      box-shadow: none;
      color: var(--muted);
    }

    .sidebar button.secondary:hover {
      border-color: var(--accent-strong);
      color: #e5e7eb;
    }

    /* Main panel */
    .panel {
      background: radial-gradient(circle at top right, #111827 0, #020617 55%);
      border-radius: var(--radius-lg);
      border: 1px solid rgba(55, 65, 81, 0.9);
      box-shadow: var(--shadow-soft);
      padding: 16px 18px 18px;
      display: flex;
      flex-direction: column;
      gap: 14px;
      min-width: 0;
    }

    .tabs {
      display: inline-flex;
      padding: 3px;
      background: rgba(15, 23, 42, 0.9);
      border-radius: 999px;
      border: 1px solid rgba(75, 85, 99, 0.9);
      gap: 3px;
    }

    .tab-btn {
      border-radius: 999px;
      border: none;
      background: transparent;
      padding: 6px 13px;
      font-size: 0.78rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--muted);
      cursor: pointer;
      transition: background 0.15s ease, color 0.15s ease;
    }

    .tab-btn.active {
      background: linear-gradient(135deg, #4f46e5, #818cf8);
      color: white;
    }

    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
    }

    .chip-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: flex-end;
      font-size: 0.78rem;
      color: var(--muted);
    }

    .chip {
      border-radius: 999px;
      border: 1px solid rgba(107, 114, 128, 0.6);
      padding: 4px 8px;
      background: rgba(15, 23, 42, 0.9);
    }

    /* Stat cards */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 10px;
    }

    .stat-card {
      border-radius: var(--radius-sm);
      background: linear-gradient(
        135deg,
        rgba(15, 23, 42, 0.98),
        rgba(15, 23, 42, 0.75)
      );
      border: 1px solid rgba(55, 65, 81, 0.9);
      padding: 9px 10px;
    }

    .stat-label {
      font-size: 0.78rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--muted);
      margin-bottom: 3px;
    }

    .stat-value {
      font-size: 1.1rem;
      font-weight: 600;
    }

    .stat-sub {
      font-size: 0.8rem;
      color: var(--muted);
      margin-top: 2px;
    }

    .stat-value.positive {
      color: var(--success);
    }

    .stat-value.negative {
      color: var(--danger);
    }

    /* Charts */
    .chart-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 12px;
      margin-top: 4px;
    }

    .chart-card {
      border-radius: var(--radius-sm);
      background: rgba(15, 23, 42, 0.95);
      border: 1px solid rgba(55, 65, 81, 0.9);
      padding: 8px 10px 10px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      min-height: 220px;
      min-width: 0;
      overflow: hidden;
    }

    .chart-title {
      font-size: 0.8rem;
      color: var(--muted);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .chart-title span.strong {
      color: #e5e7eb;
      font-weight: 500;
    }

    canvas {
      width: 100%;
      height: clamp(220px, 32vh, 360px);
      max-height: 360px;
    }

    /* Table styles */
    .table-card {
      border-radius: var(--radius-sm);
      background: rgba(15, 23, 42, 0.96);
      border: 1px solid rgba(55, 65, 81, 0.9);
      padding: 8px 10px 10px;
      min-width: 0;
    }

    .table-header {
      font-size: 0.8rem;
      color: var(--muted);
      margin-bottom: 4px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
    }

    .table-header strong {
      color: #e5e7eb;
    }

    .table-container {
      max-height: min(55vh, 360px);
      overflow: auto;
      border-radius: 10px;
      border: 1px solid rgba(31, 41, 55, 0.9);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8rem;
    }

    thead {
      background: rgba(15, 23, 42, 0.98);
      position: sticky;
      top: 0;
      z-index: 1;
    }

    th,
    td {
      padding: 7px 9px;
      border-bottom: 1px solid rgba(31, 41, 55, 0.8);
      text-align: left;
      white-space: nowrap;
    }

    th {
      font-weight: 500;
      color: var(--muted);
      cursor: pointer;
      position: relative;
      user-select: none;
    }

    th span.sort-indicator {
      font-size: 0.7rem;
      opacity: 0.7;
      margin-left: 4px;
    }

    tbody tr:nth-child(even) {
      background: rgba(15, 23, 42, 0.92);
    }

    tbody tr:hover {
      background: rgba(30, 64, 175, 0.4);
    }

    .tag {
      border-radius: 999px;
      padding: 2px 7px;
      font-size: 0.72rem;
      border: 1px solid rgba(55, 65, 81, 0.9);
    }

    .tag.cash {
      border-color: rgba(34, 197, 94, 0.7);
      color: var(--success);
      background: rgba(22, 163, 74, 0.08);
    }

    .tag.online {
      border-color: rgba(59, 130, 246, 0.8);
      color: #60a5fa;
      background: rgba(37, 99, 235, 0.07);
    }

    .tag.free {
      border-color: rgba(248, 113, 113, 0.8);
      color: #fca5a5;
      background: rgba(127, 29, 29, 0.25);
    }

    .muted {
      color: var(--muted);
    }

    .hidden {
      display: none !important;
    }

    @media (max-width: 960px) {
      .shell {
        grid-template-columns: minmax(0, 1fr);
      }
      .sidebar {
        position: static;
      }
      .stats-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
      .chart-grid {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    @media (max-width: 640px) {
      body {
        padding: 14px;
      }
      header {
        flex-direction: column;
        align-items: flex-start;
      }
      .stats-grid {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    @media (max-width: 1200px) {
      .panel-header {
        align-items: flex-start;
      }
      .chip-row {
        justify-content: flex-start;
      }
    }
  </style>
</head>
<body>
<div class="app">
  <header>
    <div class="title-block">
      <h1>Clipper & Scissors Sales Analytics</h1>
      <p>Interactive EDA on barber shop transactions loaded from sales.json</p>
    </div>
    <div class="pill">
      Live Filters
      <span class="key">Service</span>
      <span class="key">Customer</span>
      <span class="key">Date</span>
    </div>
  </header>

  <div class="shell">
    <aside class="sidebar">
      <h2>Filters</h2>

      <div class="sidebar-section">
        <label for="filterService">Service</label>
        <select id="filterService">
          <option value="__all">All services</option>
        </select>
      </div>

      <div class="sidebar-section">
        <label for="filterPayment">Payment</label>
        <select id="filterPayment">
          <option value="__all">Cash + Online</option>
          <option value="cash">Cash only</option>
          <option value="online">Online only</option>
        </select>
      </div>

      <div class="sidebar-section">
        <label>Period</label>
        <div class="group-row">
          <input type="date" id="filterStart" />
          <input type="date" id="filterEnd" />
        </div>
      </div>

      <div class="sidebar-section">
        <label for="filterSearch">Customer search</label>
        <input
          type="text"
          id="filterSearch"
          placeholder="Name or phone"
          autocomplete="off"
        />
      </div>

      <button id="applyFilters">Apply filters</button>
      <button id="resetFilters" class="secondary">Reset to full dataset</button>
    </aside>

    <main class="panel">
      <div class="panel-header">
        <div class="tabs">
          <button class="tab-btn active" data-tab="overviewTab">Overview</button>
          <button class="tab-btn" data-tab="serviceTab">By service</button>
          <button class="tab-btn" data-tab="customerTab">By customer</button>
          <button class="tab-btn" data-tab="rawTab">Raw transactions</button>
        </div>

        <div class="chip-row">
          <div class="chip" id="chipRange">Range: -</div>
          <div class="chip" id="chipSelection">Filtered: -</div>
        </div>
      </div>

      <!-- Overview tab -->
      <section id="overviewTab">
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-label">Total revenue</div>
            <div class="stat-value" id="statRevenue"></div>
            <div class="stat-sub" id="statRevenuePerDay"></div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Transactions</div>
            <div class="stat-value" id="statTx"></div>
            <div class="stat-sub" id="statTxPerDay"></div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Unique customers</div>
            <div class="stat-value" id="statCustomers"></div>
            <div class="stat-sub" id="statTopCustomer"></div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Average ticket</div>
            <div class="stat-value" id="statAvgTicket"></div>
            <div class="stat-sub" id="statMostCommonService"></div>
          </div>
        </div>

        <div class="chart-grid">
          <div class="chart-card">
            <div class="chart-title">
              <span class="strong">Revenue over time</span>
              <span class="muted" id="chartRevenueLabel"></span>
            </div>
            <canvas id="chartRevenue"></canvas>
          </div>

          <div class="chart-card">
            <div class="chart-title">
              <span class="strong">Service mix</span>
              <span class="muted">Share by count</span>
            </div>
            <canvas id="chartServiceShare"></canvas>
          </div>
        </div>
      </section>

      <!-- Service tab -->
      <section id="serviceTab" class="hidden">
        <div class="chart-grid">
          <div class="chart-card">
            <div class="chart-title">
              <span class="strong">Count by service</span>
              <span class="muted">Filtered subset</span>
            </div>
            <canvas id="chartServiceCount"></canvas>
          </div>

          <div class="chart-card">
            <div class="chart-title">
              <span class="strong">Revenue by service</span>
              <span class="muted">Sum of line item prices</span>
            </div>
            <canvas id="chartServiceRevenue"></canvas>
          </div>
        </div>

        <div class="table-card" style="margin-top: 10px;">
          <div class="table-header">
            <div>
              <strong>Service breakdown</strong>
              <span class="muted" id="serviceSummaryLabel"></span>
            </div>
          </div>
          <div class="table-container">
            <table>
              <thead>
              <tr>
                <th data-sort="service">Service <span class="sort-indicator"></span></th>
                <th data-sort="count">Count <span class="sort-indicator"></span></th>
                <th data-sort="revenue">Revenue (Rs) <span class="sort-indicator"></span></th>
                <th data-sort="avgPrice">Avg price (Rs) <span class="sort-indicator"></span></th>
              </tr>
              </thead>
              <tbody id="serviceTableBody"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- Customer tab -->
      <section id="customerTab" class="hidden">
        <div class="table-card">
          <div class="table-header">
            <div>
              <strong>Customer value table</strong>
              <span class="muted" id="customerSummaryLabel"></span>
            </div>
          </div>
          <div class="table-container">
            <table>
              <thead>
              <tr>
                <th data-sort="name">Customer <span class="sort-indicator"></span></th>
                <th data-sort="phone">Phone <span class="sort-indicator"></span></th>
                <th data-sort="visits">Visits <span class="sort-indicator"></span></th>
                <th data-sort="spend">Total spend (Rs) <span class="sort-indicator"></span></th>
                <th data-sort="avg">Avg ticket (Rs) <span class="sort-indicator"></span></th>
                <th data-sort="last">Last visit <span class="sort-indicator"></span></th>
              </tr>
              </thead>
              <tbody id="customerTableBody"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- Raw tab -->
      <section id="rawTab" class="hidden">
        <div class="table-card">
          <div class="table-header">
            <div>
              <strong>Transaction log</strong>
              <span class="muted" id="rawSummaryLabel"></span>
            </div>
          </div>
          <div class="table-container">
            <table>
              <thead>
              <tr>
                <th data-sort="date">Date <span class="sort-indicator"></span></th>
                <th data-sort="service">Service <span class="sort-indicator"></span></th>
                <th data-sort="customer">Customer <span class="sort-indicator"></span></th>
                <th data-sort="phone">Phone <span class="sort-indicator"></span></th>
                <th data-sort="price">Line price (Rs) <span class="sort-indicator"></span></th>
                <th data-sort="total">Bill total (Rs) <span class="sort-indicator"></span></th>
                <th data-sort="payment">Payment <span class="sort-indicator"></span></th>
                <th data-sort="flags">Flags <span class="sort-indicator"></span></th>
              </tr>
              </thead>
              <tbody id="rawTableBody"></tbody>
            </table>
          </div>
        </div>
      </section>
    </main>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const state = {
    rawSales: [],
    rows: [],
    filtered: [],
    charts: {}
  };

  async function loadData() {
    const res = await fetch("sales.json");
    const json = await res.json();

    state.rawSales = json;

    const rows = [];
    for (const [id, sale] of Object.entries(json)) {
      const dateStr = sale.date;
      const date = new Date(dateStr);
      const customerName = sale.customerName || "Unknown";
      const customerPhone = sale.customerPhone || "Unknown";
      const paymentMode = sale.paymentMode || "unknown";
      const total = Number(sale.total) || 0;

      const cart = Array.isArray(sale.cart) ? sale.cart : [];
      if (cart.length === 0) {
        rows.push({
          id,
          date,
          dateStr,
          customerName,
          customerPhone,
          service: "Unknown",
          price: total,
          paymentMode,
          total,
          isFree: false
        });
        continue;
      }

      for (const item of cart) {
        rows.push({
          id,
          date,
          dateStr,
          customerName,
          customerPhone,
          service: item.service || "Unknown",
          price: Number(item.price) || 0,
          paymentMode,
          total,
          isFree: Boolean(item.isFreeHaircut)
        });
      }
    }

    rows.sort((a, b) => a.date - b.date);

    state.rows = rows;
    state.filtered = rows.slice();

    populateServiceFilter();
    initCharts();
    applyFilters();
  }

  function formatCurrency(n) {
    if (!Number.isFinite(n)) return "-";
    return "Rs. " + n.toLocaleString("en-IN", { maximumFractionDigits: 0 });
  }

  function formatDate(d) {
    return d.toISOString().slice(0, 10);
  }

  function unique(array) {
    return Array.from(new Set(array));
  }

  function downsampleSeries(labels, values, maxPoints) {
    if (labels.length <= maxPoints) return { labels, values };
    const step = Math.ceil(labels.length / maxPoints);
    const dsLabels = [];
    const dsValues = [];
    for (let i = 0; i < labels.length; i += step) {
      dsLabels.push(labels[i]);
      dsValues.push(values[i]);
    }
    return { labels: dsLabels, values: dsValues };
  }

  function limitCategories(list, metricKey, maxItems, otherLabel = "Other") {
    if (list.length <= maxItems) return list;
    const head = list.slice(0, maxItems - 1);
    const tail = list.slice(maxItems - 1);
    const other = tail.reduce(
      (acc, item) => {
        acc.count += item.count || 0;
        acc.revenue += item.revenue || 0;
        acc[metricKey] += item[metricKey] || 0;
        return acc;
      },
      { service: otherLabel, count: 0, revenue: 0, [metricKey]: 0 }
    );
    other.avgPrice = other.count ? other.revenue / other.count : 0;
    return [...head, other];
  }

  function populateServiceFilter() {
    const select = document.getElementById("filterService");
    const services = unique(state.rows.map(r => r.service)).sort();
    for (const s of services) {
      const opt = document.createElement("option");
      opt.value = s;
      opt.textContent = s;
      select.appendChild(opt);
    }

    const minDate = state.rows[0]?.date;
    const maxDate = state.rows[state.rows.length - 1]?.date;
    if (minDate && maxDate) {
      document.getElementById("filterStart").value = formatDate(minDate);
      document.getElementById("filterEnd").value = formatDate(maxDate);
    }
  }

  function getFilters() {
    const service = document.getElementById("filterService").value;
    const payment = document.getElementById("filterPayment").value;
    const search = document
      .getElementById("filterSearch")
      .value.trim()
      .toLowerCase();
    const startVal = document.getElementById("filterStart").value;
    const endVal = document.getElementById("filterEnd").value;

    const start = startVal ? new Date(startVal) : null;
    const end = endVal ? new Date(endVal) : null;
    if (end) {
      end.setHours(23, 59, 59, 999);
    }

    return { service, payment, search, start, end };
  }

  function applyFilters() {
    const { service, payment, search, start, end } = getFilters();

    let rows = state.rows.slice();

    if (service !== "__all") {
      rows = rows.filter(r => r.service === service);
    }

    if (payment !== "__all") {
      rows = rows.filter(r => r.paymentMode === payment);
    }

    if (start) {
      rows = rows.filter(r => r.date >= start);
    }
    if (end) {
      rows = rows.filter(r => r.date <= end);
    }

    if (search) {
      rows = rows.filter(r => {
        const name = (r.customerName || "").toLowerCase();
        const phone = (r.customerPhone || "").toLowerCase();
        return name.includes(search) || phone.includes(search);
      });
    }

    state.filtered = rows;

    updateChips();
    updateOverview();
    updateServiceTablesAndCharts();
    updateCustomerTable();
    updateRawTable();
  }

  function resetFilters() {
    document.getElementById("filterService").value = "__all";
    document.getElementById("filterPayment").value = "__all";
    document.getElementById("filterSearch").value = "";

    const minDate = state.rows[0]?.date;
    const maxDate = state.rows[state.rows.length - 1]?.date;
    document.getElementById("filterStart").value = minDate
      ? formatDate(minDate)
      : "";
    document.getElementById("filterEnd").value = maxDate
      ? formatDate(maxDate)
      : "";

    applyFilters();
  }

  function updateChips() {
    const full = state.rows;
    const filtered = state.filtered;

    const rangeChip = document.getElementById("chipRange");
    const selectionChip = document.getElementById("chipSelection");

    if (full.length === 0) {
      rangeChip.textContent = "Range: no data";
      selectionChip.textContent = "Filtered: 0 rows";
      return;
    }

    const minDate = full[0].date;
    const maxDate = full[full.length - 1].date;
    rangeChip.textContent =
      "Range: " + formatDate(minDate) + " to " + formatDate(maxDate);

    selectionChip.textContent =
      "Filtered: " +
      filtered.length +
      " rows (" +
      ((filtered.length / full.length) * 100).toFixed(1) +
      "% of dataset)";
  }

  function updateOverview() {
    const rows = state.filtered;
    if (rows.length === 0) {
      document.getElementById("statRevenue").textContent = "-";
      document.getElementById("statRevenuePerDay").textContent =
        "No data in current filter";
      document.getElementById("statTx").textContent = "0";
      document.getElementById("statTxPerDay").textContent = "";
      document.getElementById("statCustomers").textContent = "0";
      document.getElementById("statTopCustomer").textContent = "";
      document.getElementById("statAvgTicket").textContent = "-";
      document.getElementById("statMostCommonService").textContent = "";
      updateRevenueChart([]);
      updateServiceShareChart([]);
      return;
    }

    const idToTotal = new Map();
    for (const r of rows) {
      if (!idToTotal.has(r.id)) {
        idToTotal.set(r.id, r.total);
      }
    }
    const revenue = Array.from(idToTotal.values()).reduce(
      (sum, v) => sum + v,
      0
    );
    const txCount = idToTotal.size;

    const dates = rows.map(r => r.date);
    const minDate = new Date(Math.min(...dates));
    const maxDate = new Date(Math.max(...dates));
    const dayCount =
      1 + Math.round((maxDate - minDate) / (1000 * 60 * 60 * 24)) || 1;

    const revenuePerDay = revenue / dayCount;
    const txPerDay = txCount / dayCount;

    document.getElementById("statRevenue").textContent =
      formatCurrency(revenue);
    document.getElementById("statRevenuePerDay").textContent =
      "Approx " +
      formatCurrency(revenuePerDay) +
      " per active day in range";

    document.getElementById("statTx").textContent = txCount.toString();
    document.getElementById("statTxPerDay").textContent =
      txPerDay.toFixed(1) + " tickets per day";

    const customerMap = new Map();
    for (const r of rows) {
      const key = (r.customerName || "Unknown") + "|" + (r.customerPhone || "");
      if (!customerMap.has(key)) {
        customerMap.set(key, { visits: 0, spend: 0, last: r.date });
      }
      const c = customerMap.get(key);
      c.visits += 1;
      c.spend += r.total;
      if (r.date > c.last) c.last = r.date;
    }

    const uniqueCustomers = customerMap.size;
    document.getElementById("statCustomers").textContent =
      uniqueCustomers.toString();

    let topCustomer = null;
    for (const [key, value] of customerMap.entries()) {
      if (!topCustomer || value.spend > topCustomer.spend) {
        topCustomer = { key, ...value };
      }
    }
    if (topCustomer) {
      const [name, phone] = topCustomer.key.split("|");
      document.getElementById("statTopCustomer").textContent =
        name +
        " (" +
        (phone || "no phone") +
        ") - " +
        formatCurrency(topCustomer.spend);
    } else {
      document.getElementById("statTopCustomer").textContent = "";
    }

    const avgTicket = revenue / txCount;
    document.getElementById("statAvgTicket").textContent =
      formatCurrency(avgTicket);

    const serviceCount = {};
    for (const r of rows) {
      serviceCount[r.service] = (serviceCount[r.service] || 0) + 1;
    }
    const sortedServices = Object.entries(serviceCount).sort(
      (a, b) => b[1] - a[1]
    );
    if (sortedServices.length > 0) {
      const [svc, count] = sortedServices[0];
      document.getElementById("statMostCommonService").textContent =
        svc + " - " + count + " line items";
    } else {
      document.getElementById("statMostCommonService").textContent = "";
    }

    updateRevenueChart(rows);
    updateServiceShareChart(rows);
  }

  function aggregateService(rows) {
    const map = new Map();
    for (const r of rows) {
      if (!map.has(r.service)) {
        map.set(r.service, { service: r.service, count: 0, revenue: 0 });
      }
      const agg = map.get(r.service);
      agg.count += 1;
      agg.revenue += r.price;
    }
    return Array.from(map.values()).map(a => ({
      ...a,
      avgPrice: a.count ? a.revenue / a.count : 0
    }));
  }

  function aggregateCustomers(rows) {
    const map = new Map();
    for (const r of rows) {
      const key =
        (r.customerName || "Unknown") + "|" + (r.customerPhone || "Unknown");
      if (!map.has(key)) {
        map.set(key, {
          name: r.customerName || "Unknown",
          phone: r.customerPhone || "Unknown",
          visits: 0,
          spend: 0,
          totals: new Map(),
          lastVisit: r.date
        });
      }
      const c = map.get(key);
      c.visits += 1;
      if (!c.totals.has(r.id)) {
        c.totals.set(r.id, r.total);
        c.spend += r.total;
      }
      if (r.date > c.lastVisit) c.lastVisit = r.date;
    }
    return Array.from(map.values()).map(c => ({
      ...c,
      avgTicket: c.visits ? c.spend / c.visits : 0
    }));
  }

  function initCharts() {
    const ctxRevenue = document.getElementById("chartRevenue").getContext("2d");
    const ctxServiceShare =
      document.getElementById("chartServiceShare").getContext("2d");
    const ctxServiceCount =
      document.getElementById("chartServiceCount").getContext("2d");
    const ctxServiceRevenue =
      document.getElementById("chartServiceRevenue").getContext("2d");

    state.charts.revenue = new Chart(ctxRevenue, {
      type: "line",
      data: {
        labels: [],
        datasets: [
          {
            label: "Revenue",
            data: [],
            borderWidth: 2,
            fill: true,
            tension: 0.25
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        animation: false,
        normalized: true,
        interaction: { intersect: false, mode: "index" },
        plugins: {
          legend: { display: false },
          decimation: { enabled: true, algorithm: "lttb", samples: 250 }
        },
        scales: {
          x: {
            grid: { display: false },
            ticks: { maxTicksLimit: 8 }
          },
          y: {
            grid: { color: "rgba(55,65,81,0.7)" },
            ticks: { maxTicksLimit: 5 }
          }
        }
      }
    });

    state.charts.serviceShare = new Chart(ctxServiceShare, {
      type: "doughnut",
      data: {
        labels: [],
        datasets: [
          {
            label: "Share",
            data: [],
            borderWidth: 1
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        animation: false,
        plugins: {
          legend: { position: "bottom", labels: { boxWidth: 10 } }
        },
        cutout: "65%"
      }
    });

    state.charts.serviceCount = new Chart(ctxServiceCount, {
      type: "bar",
      data: {
        labels: [],
        datasets: [
          {
            label: "Count",
            data: [],
            borderWidth: 1
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        animation: false,
        plugins: { legend: { display: false } },
        scales: {
          x: { grid: { display: false } },
          y: { grid: { color: "rgba(55,65,81,0.7)" }, ticks: { stepSize: 5 } }
        }
      }
    });

    state.charts.serviceRevenue = new Chart(ctxServiceRevenue, {
      type: "bar",
      data: {
        labels: [],
        datasets: [
          {
            label: "Revenue",
            data: [],
            borderWidth: 1
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        animation: false,
        plugins: { legend: { display: false } },
        scales: {
          x: { grid: { display: false } },
          y: { grid: { color: "rgba(55,65,81,0.7)" } }
        }
      }
    });
  }

  function updateRevenueChart(rows) {
    const chart = state.charts.revenue;
    const labelSpan = document.getElementById("chartRevenueLabel");

    if (!rows.length) {
      chart.data.labels = [];
      chart.data.datasets[0].data = [];
      chart.update();
      labelSpan.textContent = "No data in current filter";
      return;
    }

    const daily = new Map();
    for (const r of rows) {
      const key = r.dateStr;
      if (!daily.has(key)) daily.set(key, 0);
      daily.set(key, daily.get(key) + r.total);
    }

    const labels = Array.from(daily.keys()).sort();
    const values = labels.map(d => daily.get(d));
    const { labels: dsLabels, values: dsValues } = downsampleSeries(
      labels,
      values,
      400
    );

    chart.data.labels = dsLabels;
    chart.data.datasets[0].data = dsValues;
    chart.update();

    const maxVal = Math.max(...dsValues);
    labelSpan.textContent =
      "Peak day " + formatCurrency(maxVal) + " - " + dsLabels.length + " days";
  }
  function updateServiceShareChart(rows) {
    const chart = state.charts.serviceShare;
    if (!rows.length) {
      chart.data.labels = [];
      chart.data.datasets[0].data = [];
      chart.update();
      return;
    }
    const agg = aggregateService(rows);
    agg.sort((a, b) => b.count - a.count);
    const limited = limitCategories(agg, "count", 8);
    const labels = limited.map(a => a.service);
    const data = limited.map(a => a.count);

    chart.data.labels = labels;
    chart.data.datasets[0].data = data;
    chart.update();
  }

  function updateServiceTablesAndCharts() {
    const rows = state.filtered;
    const body = document.getElementById("serviceTableBody");
    body.innerHTML = "";

    if (!rows.length) {
      document.getElementById("serviceSummaryLabel").textContent =
        "No services in current filter";
      state.charts.serviceCount.data.labels = [];
      state.charts.serviceCount.data.datasets[0].data = [];
      state.charts.serviceCount.update();
      state.charts.serviceRevenue.data.labels = [];
      state.charts.serviceRevenue.data.datasets[0].data = [];
      state.charts.serviceRevenue.update();
      return;
    }

    const agg = aggregateService(rows);
    agg.sort((a, b) => b.count - a.count);

    for (const a of agg) {
      const tr = document.createElement("tr");
      tr.innerHTML =
        "<td>" +
        a.service +
        "</td>" +
        "<td>" +
        a.count +
        "</td>" +
        "<td>" +
        a.revenue.toLocaleString("en-IN") +
        "</td>" +
        "<td>" +
        a.avgPrice.toFixed(1) +
        "</td>";
      body.appendChild(tr);
    }

    document.getElementById("serviceSummaryLabel").textContent =
      agg.length + " services - " + rows.length + " line items";

    const chartData = limitCategories(agg, "count", 12);
    const labels = chartData.map(a => a.service);
    const counts = chartData.map(a => a.count);
    const revenue = chartData.map(a => a.revenue);

    const countChart = state.charts.serviceCount;
    countChart.data.labels = labels;
    countChart.data.datasets[0].data = counts;
    countChart.update();

    const revenueChart = state.charts.serviceRevenue;
    revenueChart.data.labels = labels;
    revenueChart.data.datasets[0].data = revenue;
    revenueChart.update();
  }

  function updateCustomerTable() {
    const rows = state.filtered;
    const body = document.getElementById("customerTableBody");
    body.innerHTML = "";

    if (!rows.length) {
      document.getElementById("customerSummaryLabel").textContent =
        "No customers in current filter";
      return;
    }

    const customers = aggregateCustomers(rows);
    customers.sort((a, b) => b.spend - a.spend);

    for (const c of customers) {
      const tr = document.createElement("tr");
      tr.innerHTML =
        "<td>" +
        c.name +
        "</td>" +
        "<td>" +
        c.phone +
        "</td>" +
        "<td>" +
        c.visits +
        "</td>" +
        "<td>" +
        c.spend.toLocaleString("en-IN") +
        "</td>" +
        "<td>" +
        c.avgTicket.toFixed(1) +
        "</td>" +
        "<td>" +
        formatDate(c.lastVisit) +
        "</td>";
      body.appendChild(tr);
    }

    document.getElementById("customerSummaryLabel").textContent =
      customers.length + " unique customers";
  }

  function updateRawTable() {
    const rows = state.filtered;
    const body = document.getElementById("rawTableBody");
    body.innerHTML = "";

    if (!rows.length) {
      document.getElementById("rawSummaryLabel").textContent =
        "No transactions in current filter";
      return;
    }

    for (const r of rows) {
      const tr = document.createElement("tr");
      const paymentTag =
        r.paymentMode === "cash"
          ? '<span class="tag cash">Cash</span>'
          : r.paymentMode === "online"
          ? '<span class="tag online">Online</span>'
          : '<span class="tag">' + (r.paymentMode || "unknown") + "</span>";

      const flagTag = r.isFree
        ? '<span class="tag free">Free</span>'
        : '<span class="muted">-</span>';

      tr.innerHTML =
        "<td>" +
        r.dateStr +
        "</td>" +
        "<td>" +
        r.service +
        "</td>" +
        "<td>" +
        r.customerName +
        "</td>" +
        "<td>" +
        r.customerPhone +
        "</td>" +
        "<td>" +
        r.price.toLocaleString("en-IN") +
        "</td>" +
        "<td>" +
        r.total.toLocaleString("en-IN") +
        "</td>" +
        "<td>" +
        paymentTag +
        "</td>" +
        "<td>" +
        flagTag +
        "</td>";
      body.appendChild(tr);
    }

    document.getElementById("rawSummaryLabel").textContent =
      rows.length + " line items in current view";
  }

  function setupTabs() {
    const tabs = document.querySelectorAll(".tab-btn");
    tabs.forEach(btn => {
      btn.addEventListener("click", () => {
        tabs.forEach(b => b.classList.remove("active"));
        btn.classList.add("active");

        const target = btn.getAttribute("data-tab");
        document
          .querySelectorAll("main section")
          .forEach(sec => sec.classList.add("hidden"));
        document.getElementById(target).classList.remove("hidden");
      });
    });
  }

  function setupSorting() {
    function attach(tableBodyId, mapper) {
      const table = document
        .getElementById(tableBodyId)
        .closest("table");
      const body = document.getElementById(tableBodyId);
      const headers = table.querySelectorAll("th[data-sort]");

      let sortState = { key: null, dir: 1 };

      headers.forEach(th => {
        th.addEventListener("click", () => {
          const key = th.getAttribute("data-sort");
          if (sortState.key === key) {
            sortState.dir *= -1;
          } else {
            sortState.key = key;
            sortState.dir = 1;
          }

          headers.forEach(h =>
            h.querySelector(".sort-indicator").textContent = ""
          );
          th.querySelector(".sort-indicator").textContent =
            sortState.dir === 1 ? "^" : "v";

          const rowsArray = Array.from(body.querySelectorAll("tr"));
          rowsArray.sort((a, b) => {
            const av = mapper(a, key);
            const bv = mapper(b, key);
            if (!isNaN(parseFloat(av)) && !isNaN(parseFloat(bv))) {
              return (parseFloat(av) - parseFloat(bv)) * sortState.dir;
            }
            return av.localeCompare(bv) * sortState.dir;
          });

          body.innerHTML = "";
          rowsArray.forEach(r => body.appendChild(r));
        });
      });
    }

    attach("serviceTableBody", (tr, key) => {
      const map = {
        service: 0,
        count: 1,
        revenue: 2,
        avgPrice: 3
      };
      return tr.children[map[key]].textContent.replace(/,/g, "");
    });

    attach("customerTableBody", (tr, key) => {
      const map = {
        name: 0,
        phone: 1,
        visits: 2,
        spend: 3,
        avg: 4,
        last: 5
      };
      return tr.children[map[key]].textContent.replace(/,/g, "");
    });

    attach("rawTableBody", (tr, key) => {
      const map = {
        date: 0,
        service: 1,
        customer: 2,
        phone: 3,
        price: 4,
        total: 5,
        payment: 6,
        flags: 7
      };
      return tr.children[map[key]].textContent.replace(/,/g, "");
    });
  }

  document
    .getElementById("applyFilters")
    .addEventListener("click", applyFilters);
  document
    .getElementById("resetFilters")
    .addEventListener("click", resetFilters);

  setupTabs();
  setupSorting();
  loadData();
</script>
</body>
</html>
